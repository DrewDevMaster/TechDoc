//
//  Autorelease Pool.swift
//  TechAddicted
//
//  Created by Drew on 18.06.2025.
//

import Foundation
import UIKit

/*
 –ß—Ç–æ —Ç–∞–∫–æ–µ Autorelease Pool
 
 –≠—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–æ–∂–∏—Ç—å –≤—ã—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ–±—å–µ–∫—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ release –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤.
 
 üß† –ó–∞—á–µ–º –Ω—É–∂–µ–Ω Autorelease Pool?
     ‚Ä¢    –ß—Ç–æ–±—ã –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç —Å—Ä–∞–∑—É, –∞ –æ—Ç–ª–æ–∂–∏—Ç—å release –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞/–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
     ‚Ä¢    –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –∏ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
     ‚Ä¢    –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –ø–∞–∫–µ—Ç–Ω–æ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –≤ –±–æ–ª—å—à–∏—Ö —Ü–∏–∫–ª–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç.–ø.).
 
 
 ‚úÖ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ:

 üîπ –ë–µ–∑ autoreleasepool:
 */

private func test() {
    for i in 0..<10000 {
        let image = UIImage(named: "BigImage_\(i)")
        // –æ–±—Ä–∞–±–æ—Ç–∫–∞
    }
}
/*
 ‚Ä¢    UIImage(named:) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç autoreleased –æ–±—ä–µ–∫—Ç (—Ç.–µ. –æ–Ω –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –ø–æ–∑–∂–µ, –Ω–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏).
 ‚Ä¢    –í—Å–µ —ç—Ç–∏ 10 000 UIImage –±—É–¥—É—Ç –∫–æ–ø–∏—Ç—å—Å—è –≤ autorelease pool, —Å–æ–∑–¥–∞–Ω–Ω–æ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ RunLoop.
 ‚Ä¢    –û–Ω–∏ –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ runloop-–∞ (—Ç–æ –µ—Å—Ç—å –ø–æ—Å–ª–µ –≤—Å–µ–≥–æ —Ü–∏–∫–ª–∞).
 ‚Ä¢    ‚ùóÔ∏è–ü—Ä–æ–±–ª–µ–º–∞: –æ–≥—Ä–æ–º–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –≤—Å–µ ‚Äú–≤–∏—Å—è—Ç‚Äù –≤ –ø—É–ª–µ –¥–æ –∫–æ–Ω—Ü–∞.
 */

private func test1() {
    for i in 0..<10000 {
        autoreleasepool {
            let image = UIImage(named: "BigImage_\(i)")
            // –æ–±—Ä–∞–±–æ—Ç–∫–∞
        }
    }
}

/*
 ‚Ä¢    –í –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–≤–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π autorelease pool, –∏ –∫–æ–≥–¥–∞ –∏—Ç–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å ‚Äî –æ–±—ä–µ–∫—Ç—ã –≤ –Ω—ë–º —Å—Ä–∞–∑—É –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è.
 ‚Ä¢    üìâ –≠—Ç–æ —Ä–µ–∑–∫–æ —Å–Ω–∏–∂–∞–µ—Ç –ø–∏–∫–æ–≤—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ø–∞–º—è—Ç—å, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ç—è–∂—ë–ª—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ (UIImage, NSData, NSAutoreleasePool-–ø–æ–¥–æ–±–Ω—ã–µ).
 */



/*
‚Ä¢    autoreleasepool {} –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ CPU, —Ç–∞–∫ –∫–∞–∫ —Å–æ–∑–¥–∞—ë—Ç –∏ —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É–ª –≤ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.
‚Ä¢    –ù–æ –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å –≤—ã—Å–æ–∫–∏–º —Ä–∞—Å—Ö–æ–¥–æ–º –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UIImage, NSData, –º–∞—Å—Å–∏–≤—ã) ‚Äî –æ–Ω –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –¥–∞—ë—Ç –≤—ã–∏–≥—Ä—ã—à –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ —Å—á—ë—Ç —Å–Ω–∏–∂–µ–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å –∏ —Å–∏—Å—Ç–µ–º—É.

üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–°—Ü–µ–Ω–∞—Ä–∏–π
–ë–µ–∑ autoreleasepool
–° autoreleasepool
üß† CPU –Ω–∞–≥—Ä—É–∑–∫–∞
–ù–∏–∂–µ (–º–µ–Ω—å—à–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
–ß—É—Ç—å –≤—ã—à–µ (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø—É–ª–∞)
üßÆ –ü–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
–û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ
–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∂–µ
üìâ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ—Ä–º–æ–∑–æ–≤/–∫—Ä–∞—à–µ–π
–í—ã—à–µ
–ù–∏–∂–µ (–º–µ–Ω—å—à–µ —É—Ç–µ—á–µ–∫ –∏ –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–∞–º—è—Ç—å)
üöÄ –û–±—â–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ >1000 –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö
–ú–æ–∂–µ—Ç —É—Ö—É–¥—à–∞—Ç—å—Å—è
–°—Ç–∞–±–∏–ª—å–Ω–∞


üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
üß† –ü–æ—á–µ–º—É autoreleasepool –º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –∑–∞–º–µ–¥–ª–∏—Ç—å CPU:
    ‚Ä¢    –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ autoreleasepool ‚Äî —ç—Ç–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ NSAutoreleasePool/objc_autoreleasePoolPush/Pop).
    ‚Ä¢    –û–Ω –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π, –Ω–æ –µ—Å–ª–∏ —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å –µ–≥–æ –≤–Ω—É—Ç—Ä–∏ tight loop-–∞ 10 000+ —Ä–∞–∑, ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç—ë—Ç.
    ‚Ä¢    –≠—Ç–æ –ø—Ä–µ–Ω–µ–±—Ä–µ–∂–∏–º–æ –º–∞–ª–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∂–Ω–æ –≤ real-time –∑–∞–¥–∞—á–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, frame-by-frame video, ML inference).


–°—Ü–µ–Ω–∞—Ä–∏–π
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å autoreleasepool?
–¶–∏–∫–ª —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º UIImage, NSData
‚úÖ –î–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
–ë—ç–∫–≥—Ä–∞—É–Ω–¥ –ø–∞—Ä—Å–∏–Ω–≥ JSON, XML
‚úÖ –î–∞
–†–µ–∞–ª—Ç–∞–π–º UI, –∞–Ω–∏–º–∞—Ü–∏–∏, scroll
‚ö†Ô∏è –õ—É—á—à–µ –∏–∑–±–µ–≥–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ main-thread
–õ—ë–≥–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (Int, String)
‚ùå –ù–µ –Ω—É–∂–Ω–æ
–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ
‚úÖ –î–∞

üîç –ü—Ä–∏–º–µ—Ä: –±–µ–∑ –Ω–µ–≥–æ ‚Äî –±–æ–ª—å—à–µ –ø–∏–∫–æ–≤

–ï—Å–ª–∏ –≤ for-—Ü–∏–∫–ª–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è 5000 UIImage –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:
    ‚Ä¢    –ë–µ–∑ autoreleasepool: –ø–∏–∫–æ–≤–∞—è –ø–∞–º—è—Ç—å –º–æ–∂–µ—Ç –ª–µ–≥–∫–æ –≤—ã—Ä–∞—Å—Ç–∏ –Ω–∞ 500‚Äì800 –ú–ë
    ‚Ä¢    –° autoreleasepool: –ø–∏–∫–æ–≤–∞—è –ø–∞–º—è—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å 30‚Äì50 –ú–ë ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã –Ω–µ –∫–æ–ø—è—Ç—Å—è

‚∏ª

üßæ –í—ã–≤–æ–¥

–î–∞, autoreleasepool –∏–º–µ–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é —Ü–µ–Ω—É –ø–æ CPU, –Ω–æ –≤ –æ–±–º–µ–Ω –¥–∞—ë—Ç –æ–≥—Ä–æ–º–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à –ø–æ –ø–∞–º—è—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏. –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –æ–Ω —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –º–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è = –º–µ–Ω—å—à–µ –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–∏—Å—Ç–µ–º—É = –º–µ–Ω—å—à–µ –ª–∞–≥–æ–≤ –∏ —Å–±–æ–µ–≤.
            
*/

/*
Nesting Autorelease Pools
You can also nest autorelease pools for more granular memory management. When a nested pool drains, it only releases objects created within its scope, leaving objects in the outer pool untouched.
                                            
autoreleasepool {
    // Code that may create and autorelease objects
    autoreleasepool {
        // Code that may create and autorelease more objects
    }
    // The inner pool drains, releasing its objects
    // The outer pool continues to manage its objects
}

Example 2: Nesting Autorelease Pools
autoreleasepool {
    let image = loadImageFromFile("image.png")
    autoreleasepool {
        let thumbnail = createThumbnail(image)
        // Process the thumbnail
        // The 'thumbnail' object will be released when the inner pool drains
    }
    // The 'image' object is still managed by the outer pool
}
*/
